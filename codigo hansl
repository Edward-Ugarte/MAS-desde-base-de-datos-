# ===========================
# 🧮 Estimación de tamaño muestral e IC
# Basado en datos de ingresos – Métodos A, B y C
# Versión final optimizada por Edward Ugarte
# ===========================

clear

# 📁 Abrir base de datos
open "BdD.gdt"

# 📊 Parámetros derivados de la serie "ingresos"
scalar sigma2 = var(ingresos)            # Varianza muestral
scalar sigma  = sqrt(sigma2)             # Desvío estándar
scalar media  = mean(ingresos)           # Media muestral
scalar N      = sum(ok(ingresos))        # Total de observaciones válidas
scalar E      = 15                       # Error máximo permitido
scalar Z      = 1.96                     # Z para 95% de confianza

# 🔧 Estimación del tamaño muestral por tres métodos
scalar n_A1 = (Z^2 * sigma2) / E^2
scalar n_A  = n_A1 / (1 + n_A1 / N)

scalar n_B  = (N * Z^2 * sigma2) / (N * E^2 + Z^2 * sigma2)
scalar n_C  = sigma2 / ((E / Z)^2 + (sigma2 / N))

# 🎯 Redondeo operativo basado en Método A
scalar n_final = ceil(n_A)

# 📌 Resultados de tamaño muestral
printf "🚀 ==== Estimación del tamaño muestral ====\n"
printf "📊 Método A (ajustado): %.3f\n", n_A
printf "📊 Método B: %.3f\n", n_B
printf "📊 Método C: %.3f\n", n_C
printf "✅ Tamaño muestral final a usar (redondeado): %.0f\n", n_final

# 🧮 Intervalo de confianza usando n_final
scalar f      = n_final / N
scalar margen = Z * sigma / sqrt(n_final) * sqrt(1 - f)
scalar inf    = media - margen
scalar sup    = media + margen

# 🧾 Resultados del intervalo de confianza
printf "\n📐 Intervalo de confianza al 95%% (n = %.0f):\n", n_final
printf "   - Media esperada     : %.2f\n", media
printf "   - Margen de error    : %.2f\n", margen
printf "   - Límite inferior    : %.2f\n", inf
printf "   - Límite superior    : %.2f\n", sup
